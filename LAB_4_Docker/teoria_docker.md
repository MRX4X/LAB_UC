# Теория: Docker

Теоретический материал к лабораторной работе «Основы Docker». Каждый раздел соответствует части лабораторной работы.

---

## Введение

**Docker** — это платформа для разработки, доставки и запуска приложений в контейнерах. Контейнеры позволяют упаковать приложение со всеми его зависимостями (библиотеками, конфигурациями, переменными окружения) в единый переносимый пакет, который можно запустить в любой среде, где установлен Docker.

**Проверка установки:** `docker --version` — версия; `docker run hello-world` — тестовый образ, подтверждающий, что Docker работает.

---

## Основные понятия

### Образ (Image)

**Образ** — неизменяемый шаблон (read-only) с инструкциями для создания контейнера. Он содержит:
- Файловую систему приложения
- Зависимости и библиотеки
- Конфигурацию
- Команду для запуска

Образы организованы слоями: каждый слой добавляет изменения к предыдущему. Это обеспечивает эффективное кэширование и переиспользование при сборке.

**Реестр образов** — хранилище образов. Самый популярный — Docker Hub (hub.docker.com). Образы именуются как `репозиторий:тег` (например, `nginx:alpine`, `ubuntu:22.04`).

### Контейнер (Container)

**Контейнер** — запущенный экземпляр образа. Контейнер:
- Изолирован от хост-системы и других контейнеров
- Использует ядро хоста (в отличие от виртуальных машин)
- Может быть создан, запущен, остановлен и удалён
- Эфемерен: данные в контейнере теряются при удалении (если не используются тома)

**Разница между образом и контейнером:** образ — это шаблон, контейнер — работающая копия. Из одного образа можно запустить множество контейнеров.

---

## Архитектура Docker

Docker использует клиент-серверную архитектуру:

- **Docker Daemon (dockerd)** — фоновый процесс, который управляет образами, контейнерами, сетями и томами. Выполняет все операции.
- **Docker Client (docker)** — CLI-интерфейс, через который пользователь отправляет команды демону.
- **Docker Registry** — сервис хранения и распространения образов.

При запуске контейнера Docker:
1. Создаёт изолированное пространство имён (процессы, сеть, файловая система)
2. Выделяет ресурсы (CPU, память)
3. Запускает указанную команду как основной процесс контейнера

---

## Контейнеры vs виртуальные машины

| Аспект | Контейнеры (Docker) | Виртуальные машины |
|--------|---------------------|---------------------|
| Изоляция | На уровне процессов | Полная виртуализация ОС |
| Гостевая ОС | Нет (общее ядро хоста) | Да, полная копия |
| Запуск | Секунды | Минуты |
| Размер | МБ | ГБ |
| Потребление ресурсов | Низкое | Высокое |

Контейнеры легче и быстрее, но изоляция слабее, чем у ВМ. Для большинства приложений контейнеры — оптимальный выбор.

---

## Основные команды Docker

### Работа с образами
- **`docker pull образ:тег`** — скачать образ из реестра (Docker Hub по умолчанию). Примеры: `ubuntu:22.04`, `nginx:alpine`.
- **`docker images`** — список локальных образов (REPOSITORY, TAG, IMAGE ID, SIZE). Опция `-a` — и промежуточные образы.
- **`docker build -t имя:тег .`** — собрать образ из Dockerfile в текущем каталоге.
- **`docker rmi образ`** — удалить образ.

### Работа с контейнерами
- **`docker run`** — создать и запустить **новый** контейнер из образа.
- **`docker ps`** — только запущенные контейнеры; **`docker ps -a`** — все (включая остановленные, статус Exited).
- **`docker start/stop/restart контейнер`** — запуск, остановка, перезапуск уже созданного контейнера. `stop` отправляет сигнал SIGTERM.
- **`docker exec -it контейнер команда`** — выполнить команду **в уже работающем** контейнере (не создаёт новый). Для входа в оболочку: `docker exec -it my-web /bin/sh` (в Alpine нет bash, используется sh).
- **`docker logs контейнер`** — stdout и stderr контейнера. Опция `-f` — вывод логов в реальном времени.
- **`docker rm контейнер`** — удалить контейнер. Обычно контейнер должен быть остановлен; `-f` — принудительно удалить запущенный.

**Разница `run` и `exec`:** `run` создаёт новый контейнер; `exec` выполняет команду в уже запущенном.

### Опции docker run
- **`-d`** (detached) — запуск в фоне, без вывода логов контейнера в терминал.
- **`-it`** — интерактивный режим: `-i` оставляет STDIN открытым, `-t` выделяет TTY. Данные параметры нужны для работы в оболочке.
- **`-p хост:контейнер`** — проброс портов. Пример: `-p 8080:80` — порт 8080 на хосте → 80 в контейнере. Без `-p` контейнер недоступен с хоста.
- **`--name имя`** — задать имя контейнера (иначе случайный ID).
- **`-v хост:контейнер`** — монтирование томов.
- **`-e VAR=value`** — переменные окружения.

**Пример:** Nginx слушает порт 80 внутри контейнера. Каталог с HTML — `/usr/share/nginx/html`.

---

## Docker Compose

**Docker Compose** — инструмент для определения и запуска multi-контейнерных приложений через файл `docker-compose.yaml`.

Структура YAML:
- **`services`** — список сервисов (контейнеров)
- У каждого сервиса: **`image`** — образ, **`container_name`** — имя контейнера, **`ports`** — проброс в формате `"хост:контейнер"`, **`command`** — переопределение команды по умолчанию
- Имена сервисов (`web`, `app`) используются в командах: `docker compose logs web`

Пример: сервис с `command: sleep 3600` — держит контейнер запущенным 1 час (Alpine без команды сразу завершится).

**Пример docker-compose.yaml:**

```yaml
services:
  web:
    image: nginx:alpine
    container_name: lab-nginx
    ports:
      - "8080:80"
  app:
    image: alpine:latest
    container_name: lab-alpine
    command: sleep 3600
```

После `docker compose up -d` Nginx будет доступен на `http://localhost:8080`.

Основные команды:
- **`docker-compose up -d`** — создать и запустить все сервисы в фоне
- **`docker-compose down`** — остановить и удалить контейнеры
- **`docker-compose ps`** — статус контейнеров проекта
- **`docker-compose logs -f`** — логи всех сервисов с отслеживанием (Ctrl+C — выход)


---

## Dockerfile

**Dockerfile** — текстовый файл с инструкциями для сборки образа. Лежит в каталоге, откуда запускается `docker build -t имя:тег .` (точка — текущий каталог).

Основные инструкции:
- **`FROM образ`** — базовый образ (обязательная первая инструкция). Пример: `FROM nginx:alpine`.
- **`RUN команда`** — выполнить команду при сборке. Пример: `RUN echo '<h1>Текст</h1>' > /usr/share/nginx/html/index.html` — перезаписать index.html.
- **`COPY src dest`** / **`ADD src dest`** — копировать файлы в образ
- **`WORKDIR путь`** — рабочая директория
- **`ENV VAR=value`** — переменные окружения
- **`EXPOSE порт`** — объявить порт (документация)
- **`CMD ["команда", "арг"]`** — команда при запуске контейнера
- **`ENTRYPOINT`** — неизменяемая точка входа

Каждая инструкция создаёт новый слой образа. Важно минимизировать количество слоёв и использовать `.dockerignore` для исключения лишних файлов.

---

## Тома (Volumes) и bind mounts

**Volumes** — управляемое Docker хранилище данных, сохраняющееся при удалении контейнера. Идеально для БД и постоянных данных.

**Bind mounts** — привязка конкретной директории хоста к контейнеру. Удобно при разработке для live-обновления кода.

**Примеры:**

```bash
# Named volume — Docker создаёт том mydata и монтирует в /var/lib/mysql
docker run -d -v mydata:/var/lib/mysql mysql:8

# Bind mount — папка ./html на хосте → /usr/share/nginx/html в контейнере
docker run -d -v $(pwd)/html:/usr/share/nginx/html -p 8080:80 nginx:alpine
```

В docker-compose.yaml:
```yaml
services:
  db:
    image: postgres:15-alpine
    volumes:
      - db_data:/var/lib/postgresql/data   # named volume
  web:
    image: nginx:alpine
    volumes:
      - ./html:/usr/share/nginx/html       # bind mount
volumes:
  db_data:   # объявление named volume
```

---

## Сети Docker

Docker предоставляет встроенные сетевые драйверы:
- **bridge** — сеть по умолчанию, контейнеры видят друг друга по имени
- **host** — контейнер использует сеть хоста напрямую
- **none** — изоляция от сети

Контейнеры в одной сети могут обращаться друг к другу по имени сервиса (в Compose) или имени контейнера.

---